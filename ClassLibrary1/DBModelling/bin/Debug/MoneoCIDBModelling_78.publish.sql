/*
Deployment script for moneosi

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "moneosi"
:setvar DefaultFilePrefix "moneosi"
:setvar DefaultDataPath "D:\RDSDBDATA\DATA\"
:setvar DefaultLogPath "D:\RDSDBDATA\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key f5fa0914-ff50-401b-9490-20a272570c6c is skipped, element [dbo].[CAMPANHAS_CONSOLIDADO].[TIPOCAMPANHA] (SqlSimpleColumn) will not be renamed to TIPOCAMPANHAID';


GO
PRINT N'Altering [dbo].[CAMPANHAS]...';


GO
ALTER TABLE [dbo].[CAMPANHAS] DROP COLUMN [DDD];


GO
ALTER TABLE [dbo].[CAMPANHAS]
    ADD [DDD] AS CAST ((SUBSTRING(CAST ([CELULAR] AS VARCHAR (11)), (0), (3))) AS TINYINT);


GO
PRINT N'Altering [dbo].[CAMPANHAS_CONSOLIDADO]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
ALTER TABLE [dbo].[CAMPANHAS_CONSOLIDADO]
    ADD [TIPOCAMPANHAID] TINYINT NULL;


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering [dbo].[CONSOLIDADO_CAMPANHAS_AGENDADA]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
ALTER PROC dbo.CONSOLIDADO_CAMPANHAS_AGENDADA    
@DataInicial DATE,    
@DataFinal  DATE    
AS    
CREATE TABLE #TMP(    
QUANTIDADE  INT,    
ARQUIVOID  INT,     
FORNECEDORID INT,    
CARTEIRAID  INT,     
DATAENVIAR  SMALLDATETIME,     
DATADIA   DATE,    
STATUSENVIO  TINYINT,    
STATUSREPORT TINYINT,    
CLIENTEID  INT,    
USUARIOID  INT,    
SPCAPITAL  INT,    
SPGRANDE  INT,    
DEMAISDDD  INT,
TIPOCAMPANHAID	INT
);    
BEGIN    
WITH ENVIADAS AS    
(    
 SELECT CAMPANHAID, ARQUIVOID, CARTEIRAID, STATUSREPORT, STATUSENVIO, FORNECEDORID, DATAENVIAR, DATADIA, CLIENTEID, USUARIOID,     
 CASE WHEN CAST(SUBSTRING(CAST(CELULAR AS VARCHAR(11)), 0, 3) AS INT)=11 THEN 1 ELSE 0 END SPCAPITAL    
 ,CASE WHEN CAST(SUBSTRING(CAST(CELULAR AS VARCHAR(11)), 0, 3) AS INT)>11 AND CAST(SUBSTRING(CAST(CELULAR AS VARCHAR(11)), 0, 3) AS INT)<=19 THEN 1 ELSE 0 END SPGRANDE
 ,CASE WHEN CAST(SUBSTRING(CAST(CELULAR AS VARCHAR(11)), 0, 3) AS INT)>19 THEN 1 ELSE 0 END DEMAISDDD, TIPOCAMPANHAID
 FROM CAMPANHAS WHERE DATADIA BETWEEN @DataInicial AND @DataFinal    
)    
INSERT #TMP    
SELECT COUNT(CAMPANHAID), ARQUIVOID, FORNECEDORID, CARTEIRAID, DATAENVIAR, DATADIA,     
CASE WHEN STATUSENVIO=1 OR STATUSENVIO=0 THEN 3 ELSE STATUSENVIO END, STATUSREPORT, CLIENTEID, USUARIOID    
,SUM(SPCAPITAL) SPCAPITAL, SUM(SPGRANDE) SPGRANDE, SUM(DEMAISDDD) DEMAISDDD, TIPOCAMPANHAID
FROM ENVIADAS GROUP BY ARQUIVOID, FORNECEDORID, CARTEIRAID, DATAENVIAR, DATADIA, STATUSENVIO, FORNECEDORID, STATUSREPORT, CLIENTEID, USUARIOID, TIPOCAMPANHAID   
    
DECLARE @TMP TABLE (    
CODIGO   INT IDENTITY(1,1),    
CARTEIRAID  INT,     
ARQUIVOID  INT,     
DATAENVIAR  SMALLDATETIME,     
DATADIA   DATE,    
FORNECEDORID INT,    
STATUSREPORT TINYINT,    
ERRO   INT,    
SUSPENSA  INT,    
CANCELADA  INT,    
CLIENTEID  INT,    
USUARIOID  INT,    
ENVIADA   INT,    
SPCAPITAL  INT,    
SPGRANDE  INT,    
DEMAISDDD  INT,
TIPOCAMPANHAID INT
);    
    
INSERT @TMP    
SELECT CARTEIRAID, ARQUIVOID, DATAENVIAR, DATADIA, FORNECEDORID, ISNULL(STATUSREPORT, 99) STATUSREPORT,ISNULL([3],0) ERRO, ISNULL([4],0) SUSPENSA, ISNULL([5],0) CANCELADA, CLIENTEID, USUARIOID, ISNULL([2],0) ENVIADA, SPCAPITAL, SPGRANDE, DEMAISDDD FROM   
  
(SELECT QUANTIDADE, STATUSENVIO, CARTEIRAID, ARQUIVOID, DATAENVIAR, DATADIA, FORNECEDORID, STATUSREPORT, CLIENTEID, USUARIOID, SPCAPITAL, SPGRANDE, DEMAISDDD FROM #TMP) AS PVT PIVOT(SUM(QUANTIDADE) FOR STATUSENVIO IN([2],[3],[4],[5])) AS P;    
    
WITH CONSOLIDADA AS(    
SELECT SUSPENSA, CANCELADA, ERRO, ARQUIVOID, CARTEIRAID, DATAENVIAR, FORNECEDORID, DATADIA, ISNULL([68],0) EXCLUIDA, ISNULL([0], 0) ENTREGUE, ISNULL([70],0) EXPIRADA, CLIENTEID, USUARIOID, ISNULL([99],0) ENVIADA, SPCAPITAL, SPGRANDE, DEMAISDDD, TIPOCAMPANHAID FROM     
(SELECT SUSPENSA, ERRO, CANCELADA, ARQUIVOID, DATAENVIAR, FORNECEDORID, STATUSREPORT, CARTEIRAID, DATADIA, CLIENTEID, USUARIOID, ENVIADA, SPCAPITAL, SPGRANDE, DEMAISDDD, TIPOCAMPANHAID FROM @TMP) AS PVT PIVOT (SUM(ENVIADA) FOR STATUSREPORT IN([68],[0],[70], [99])) AS P) 

INSERT CAMPANHAS_CONSOLIDADO    
SELECT CARTEIRAID, ARQUIVOID,  DATAENVIAR, USUARIOID, CLIENTEID,EXCLUIDA,ERRO,SUSPENSA,ENTREGUE,EXPIRADA, DATADIA, FORNECEDORID, CANCELADA,SPCAPITAL, SPGRANDE, DEMAISDDD, ENVIADA, TIPOCAMPANHAID FROM CONSOLIDADA C    
    
DROP TABLE #TMP  
  
INSERT INTO CELULARES_INVALIDOS_CONSOLIDADO  
SELECT TIPOINVALIDO, CLIENTEID, USUARIOID, COUNT(CODIGO), CARTEIRAID, ARQUIVO, CAST(DATAENVIAR AS DATE) FROM  [dbo].[CELULARES_INVALIDOS] WHERE DATAENVIAR BETWEEN @DataInicial AND @DataFinal GROUP BY CLIENTEID, USUARIOID, CARTEIRAID, ARQUIVO, CAST(DATAENVIAR AS DATE), TIPOINVALIDO  
END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[HIGIENIZA]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[HIGIENIZA]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[CAMPANHA_RETORNO_PAGINACAO]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[CAMPANHA_RETORNO_PAGINACAO]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[CONSOLIDADO_STATUS_PAGINACAO]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[CONSOLIDADO_STATUS_PAGINACAO]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Refreshing [dbo].[CAMPANHA_CONSOLIDADO_ENVIOS_PAGINACAO]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[CAMPANHA_CONSOLIDADO_ENVIOS_PAGINACAO]';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f5fa0914-ff50-401b-9490-20a272570c6c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f5fa0914-ff50-401b-9490-20a272570c6c')

GO

GO
PRINT N'Update complete.';


GO
